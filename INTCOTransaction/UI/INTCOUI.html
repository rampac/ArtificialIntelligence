<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>


.upload-btn-wrapper {
  position: relative;
  overflow: hidden;
  display: inline-block;
}

.btnn {
  border: 2px solid gray;
  color: gray;
  background-color: white;
  padding: 8px 20px;
  border-radius: 8px;
  font-size: 20px;
  font-weight: bold;
  width:400px;
  
}

.upload-btn-wrapper input[type=file] {
  font-size: 100px;
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
}

#responseTableData {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    border-collapse: collapse;
    width: 100%;
}

#responseTableData td, #responseTableData th {
    border: 1px solid #ddd;
    padding: 8px;
}

#responseTableData tr:nth-child(even){background-color: #f2f2f2;}

#responseTableData tr:hover {background-color: #ddd;}

#responseTableData th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #4CAF50;
    color: white;
}

#preview {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    border-collapse: collapse;
    width: 100%;
}

#preview td, #preview th {
    border: 1px solid #ddd;
    padding: 8px;
}

#preview tr:nth-child(even){background-color: #f2f2f2;}

#preview tr:hover {background-color: #ddd;}

#preview th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #4CAF50;
    color: white;
}
</style>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
<script type="text/javascript"> 

var jsondata = null;
  
function ExportToTable() {  
     var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xlsx|.xls)$/;  
     /*Checks whether the file is a valid excel file*/  
     if (regex.test($("#excelfile").val().toLowerCase())) {  
         var xlsxflag = false; /*Flag for checking whether excel is .xls format or .xlsx format*/  
         if ($("#excelfile").val().toLowerCase().indexOf(".xlsx") > 0) {  
             xlsxflag = true;  
         }  
         /*Checks whether the browser supports HTML5*/  
         if (typeof (FileReader) != "undefined") {  
             var reader = new FileReader();  
             reader.onload = function (e) {  
                 var data = e.target.result;  
                 /*Converts the excel data in to object*/  
                 if (xlsxflag) {  
                     var workbook = XLSX.read(data, { type: 'binary' });  
                 }  
                 else {  
                     var workbook = XLS.read(data, { type: 'binary' });  
                 }  
                 /*Gets all the sheetnames of excel in to a variable*/  
                 var sheet_name_list = workbook.SheetNames;  
  
                 var cnt = 0; /*This is used for restricting the script to consider only first sheet of excel*/  
                 sheet_name_list.forEach(function (y) { /*Iterate through all sheets*/  
                     /*Convert the cell value to Json*/  
                     if (xlsxflag) {  
                         var exceljson = XLSX.utils.sheet_to_json(workbook.Sheets[y]);  
                     }  
                     else {  
                         var exceljson = XLS.utils.sheet_to_row_object_array(workbook.Sheets[y]);  
                     }  
                     if (exceljson.length > 0 && cnt == 0) {  
                         BindTable(exceljson, '#exceltable');  
                         cnt++;  
                     }  
                 });  
                 $('#exceltable').show();  
             }  
             if (xlsxflag) {/*If excel file is .xlsx extension than creates a Array Buffer from excel*/  
                 reader.readAsArrayBuffer($("#excelfile")[0].files[0]);  
             }  
             else {  
                 reader.readAsBinaryString($("#excelfile")[0].files[0]);  
             }  
         }  
         else {  
             alert("Sorry! Your browser does not support HTML5!");  
         }  
     }  
     else {  
         alert("Please upload a valid Excel file!");  
     }  
 }  

 
function submitForm(){
	var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
		
		document.getElementById('previewDataDiv').style.display = 'none';
		
		var jsonStr = this.responseText.replace(/\\/g, '');
		jsonStr = jsonStr.substring(1, jsonStr.length-2);
		jsonData = JSON.parse(jsonStr);
		 

		//JSONToCSVConvertor(JSON.parse(jsonStr), 'Model Report', true);
		
		var col = [];
        for (var i = 0; i < jsonData.length; i++) {
            for (var key in jsonData[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }
		document.getElementById('responseData').style.display = 'block';
        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
		table.setAttribute("id", "preview");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < jsonData.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = jsonData[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("showData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
		
		
        }
    };
    xhttp.open("POST", "http://localhost:5000/postdata", true);
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send(jsondata);
}


function fetchPDData(){
	
	var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
		document.getElementById('responsePDData').style.display = 'none';
	
		var jsonStr = this.responseText.replace(/\\/g, '');
		jsonStr = jsonStr.substring(1, jsonStr.length-2);
		jsonData = JSON.parse(jsonStr);
		console.log(jsonData);

		//JSONToCSVConvertor(JSON.parse(jsonStr), 'Model Report', true);
		
		var col = [];
        for (var i = 0; i < jsonData.length; i++) {
            for (var key in jsonData[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }
		document.getElementById('previewPDDataDiv').style.display = 'block';
        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
		table.setAttribute("id", "preview");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < jsonData.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = jsonData[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("previewPDData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
        }
    };
    xhttp.open("GET", "http://localhost:5000/fetchPDdata", true);
	xhttp.send();
}


function runModelForPD(){
	$('submitPDFeature').prop('disabled', true);
	var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
		document.getElementById('previewPDDataDiv').style.display = 'none';
	
		var jsonStr = this.responseText.replace(/\\/g, '');
		jsonStr = jsonStr.substring(1, jsonStr.length-2);
		jsonData = JSON.parse(jsonStr);
		
		var col = [];
        for (var i = 0; i < jsonData.length; i++) {
            for (var key in jsonData[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }
		document.getElementById('responsePDData').style.display = 'block';
        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
		table.setAttribute("id", "preview");

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < jsonData.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = jsonData[i][col[j]];
            }
        }

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("showPDData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
        }
    };
    xhttp.open("GET", "http://localhost:5000/runPDdata", true);
	xhttp.send();
}

function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel) {
  //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
  var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;

  var CSV = '';
  //Set Report title in first row or line

  CSV += ReportTitle + '\r\n\n';

  //This condition will generate the Label/Header
  if (ShowLabel) {
    var row = "";

    //This loop will extract the label from 1st index of on array
    for (var index in arrData[0]) {

      //Now convert each value to string and comma-seprated
      row += index + ',';
    }

    row = row.slice(0, -1);

    //append Label row with line break
    CSV += row + '\r\n';
  }

  //1st loop is to extract each row
  for (var i = 0; i < arrData.length; i++) {
    var row = "";

    //2nd loop will extract each column and convert it in string comma-seprated
    for (var index in arrData[i]) {
      row += '"' + arrData[i][index] + '",';
    }

    row.slice(0, row.length - 1);

    //add a line break after each row
    CSV += row + '\r\n';
  }

  if (CSV == '') {
    alert("Invalid data");
    return;
  }

  //Generate a file name
  var fileName = "MyReport_";
  //this will remove the blank-spaces from the title and replace it with an underscore
  fileName += ReportTitle.replace(/ /g, "_");

  //Initialize file format you want csv or xls
  var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);

  // Now the little tricky part.
  // you can use either>> window.open(uri);
  // but this will not work in some browsers
  // or you will not get the correct file extension    

  //this trick will generate a temp <a /> tag
  var link = document.createElement("a");
  link.href = uri;

  //set the visibility hidden so it will not effect on your web-layout
  link.style = "visibility:hidden";
  link.download = fileName + ".csv";

  //this part will append the anchor tag and remove it after automatic click
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function handleFileSelect(evt) {
    var files = evt.target.files;
    var xl2json = new ExcelToJSON();
    xl2json.parseExcel(files[0]);
  }
  
  var ExcelToJSON = function() {
	
      this.parseExcel = function(file) {
        var reader = new FileReader();

        reader.onload = function(e) {
          var data = e.target.result;
          var workbook = XLSX.read(data, {
            type: 'binary'
          });
          workbook.SheetNames.forEach(function(sheetName) {
            // Here is your object
            var XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
            var json_object = JSON.stringify(XL_row_object);
            console.log(JSON.parse(json_object));
			jsondata = json_object;
			jsondata2 = JSON.parse(jsondata);
			var divContainer = document.getElementById("noOfRecords");
			divContainer.innerHTML = jsondata2.length;
				
			var col = [];
			for (var i = 0; i < jsondata2.length; i++) {
				for (var key in jsondata2[i]) {
					if (col.indexOf(key) === -1) {
						col.push(key);
					}
				}
			}
			document.getElementById('previewDataDiv').style.display = 'block';
			// CREATE DYNAMIC TABLE.
			var table = document.createElement("table");
			table.setAttribute("id", "preview");

			var tr = table.insertRow(-1);                   

			for (var i = 0; i < col.length; i++) {
				var th = document.createElement("th");      
				th.innerHTML = col[i];
				tr.appendChild(th);
			}

			// ADD JSON DATA TO THE TABLE AS ROWS.
			for (var i = 0; i < jsondata2.length; i++) {

				tr = table.insertRow(-1);

				for (var j = 0; j < col.length; j++) {
					var tabCell = tr.insertCell(-1);
					tabCell.innerHTML = jsondata2[i][col[j]];
				}
			}
			
			var divContainer = document.getElementById("previewData");
			divContainer.innerHTML = "";
			divContainer.appendChild(table);
          })
        };

        reader.onerror = function(ex) {
          console.log(ex);
        };

        reader.readAsBinaryString(file);
      };
  };

 </script>
   
</head>
<body style="font-family:Verdana;color:#aaaaaa;">
<div style="padding:100px;">
<div class="container" style="width:700px">
  <div class="panel panel-default">
    <div class="panel-heading" style="text-align:center">Isolation Forest Model</div>
	<br>
	<div style="padding:10px;">
	<button class="btn btn-info" data-toggle="collapse" data-target="#clientData">Use your test data</button>

	<div id="clientData" class="collapse">
		<div  class="panel-body">
				<div class="col-md-8 col-md-offset-2">
				<form method="POST" action="#" enctype="multipart/form-data">
					<div class="form-group">
						<div class="input-group input-file" name="Fichier1" >
							<input id="upload" type=file class="form-control" name="files[]" />
							 <script>
								document.getElementById('upload').addEventListener('change', handleFileSelect, false);
							</script>
							<span class="input-group-btn" style="padding-left:50px;">
								 <button type="button" class="btn btn-primary" onclick="submitForm()">Submit</button>
							</span>
						</div>
					</div>
				</form>
				
				</div>
				<br>
				
		</div>
		<div id="previewDataDiv" style="overflow-y: scroll;overflow-x: scroll;resize: vertical;display:none; height: 15em;">
			Data Preview
			<p id="previewData"></p>
		</div>
		<div id="responseData" style="overflow-y: scroll;overflow-x: scroll;resize: vertical;display:none; height: 15em;">
			Model Result
			<p id="showData"></p>
		</div>
	</div>
	</div>
	<div style="padding:10px;">
		<button class="btn btn-info" data-toggle="collapse" data-target="#modelDetails">Model Details</button>
		<div id="modelDetails" class="collapse" style="padding:15px;">
			<table id="preview">
			  <tr>
				<th>Model Name</th>
				<th>Model Features</th>
				<th>Model Type</th>
				<th>Test Data(# of rows)</th>
			  </tr>
			  <tr>
				<td>Isolation Forest</td>
				<td>Company<br>Trading Partner<br>Customer<br>Vendor<br>Currency<br>GL Account<br>Transaction Type<br>Data Category<br>Data Source</td>
				<td>Clustering</td>
				<td><p id="noOfRecords"></p></td>
			  </tr>
			</table>
		</div>
	</div>
	<div style="padding:10px;">
		<button class="btn btn-info" data-toggle="collapse" data-target="#predefinedData">Use predefined test data</button>
		<div id="predefinedData" class="collapse">
			<div  class="panel-body">
				<div class="col-md-8 col-md-offset-2">
				<form method="POST" action="#" enctype="multipart/form-data">
					<div class="form-group">
						<div class="input-group input-file">
							<span class="input-group-btn" style="padding-left:50px;">
								 <button type="button" class="btn btn-primary" onclick="fetchPDData()">Preview data</button>
							</span>
							<span class="input-group-btn" style="padding-left:50px;">
								 <button type="button" id="submitPDFeature" class="btn btn-primary" onclick="runModelForPD()">Run Model</button>
							</span>
						</div>
					</div>
				</form>
			</div>
		</div>
		<div id="previewPDDataDiv" style="overflow-y: scroll;overflow-x: scroll;resize: vertical;display:none; height: 15em;">
			Data Preview
			<p id="previewPDData"></p>
		</div>
		<div id="responsePDData" style="overflow-y: scroll;overflow-x: scroll;resize: vertical;display:none; height: 15em;">
			Model Result
			<p id="showPDData"></p>
		</div>
		</div>
	</div>
  <div style="padding:10px;">
</div>
</div>
</div>

</body>
</html>
